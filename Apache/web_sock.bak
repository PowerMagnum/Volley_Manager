//let socket = new WebSocket("wss://192.168.1.91:4455");
//let socket = new WebSocket("wss://javascript.info/article/websocket/demo/hello");
//let socket = new WebSocket("ws://192.168.1.91:4455");

//function connect(psw, ip){
    console.log("logging");
    //console.log(psw,ip);
    setCookie("IP",ip,1);
    setCookie("CODE",psw,1);
    var id_item = {};
    var item_id = {};
    var now_showed = 0;
    
    const FullGoal = 25;
    const HalfGoal = 15;
    var Goal = FullGoal;
    var G_shift = 0;
    var AP_LogStyle = "color:#00FF00;";
    var AP_AntiSpam = "";
    var AP_AntiSpam_Goal = "";
    var AP_Enable = true;
    var lastWinner = 0;

    try{
        let socket = new WebSocket("ws://" + ip + ":4455");
        let py_sock = new WebSocket("ws://" + ip + ":8765"); 

        socket.onopen = function(e) {
            console.log("[OBS] Connection established");
        };

        socket.onmessage = function(event) {
            console.log(`[OBS] Data received from server:`);
            console.log(JSON.parse(event.data));
            if (JSON.parse(event.data)['op'] == 0 ){
                var autentica = "";

                if(JSON.parse(event.data)['d'].hasOwnProperty('authentication')){
                    var challenge = JSON.parse(event.data)['d']['authentication']['challenge'];
                    var salt = JSON.parse(event.data)['d']['authentication']['salt'];

                    hash(psw + salt).then(function(value){
                        autentica = hexToBase64(value);
                        hash(autentica + challenge).then(function(value){
                            autentica = hexToBase64(value);                   
                            let auth = {"op": 1, "d": { "rpcVersion": 1, "authentication": autentica,  "eventSubscriptions": 33}};
                            socket.send(JSON.stringify(auth));
                        });
                    });
                }else{
                    let auth = {"op": 1, "d": { "rpcVersion": 1, "authentication": autentica, "eventSubscriptions": 33 }};
                    socket.send(JSON.stringify(auth));
                }
            }else if(JSON.parse(event.data)['op'] == 2 ){
                console.log("-#-#-[ SERVER OBS PRONTO AL FUNZIONAMENTO ]-#-#-");
                getItem();
            }else if(JSON.parse(event.data)['op'] == 7 ){
                //console.log(JSON.parse(event.data)['d']['responseData']);
                if(JSON.parse(event.data)['d']['requestType'] == "GetSceneItemList"){
                    items = JSON.parse(event.data)['d']['responseData']['sceneItems'];
                    //console.log("Gransuca",items);
                    for(i in items){
                        if(items[i]['sourceName'] == 'AvvisoMatchPoint'){
                            console.log("Matchpoint:",items[i]['sceneItemId']);
                            item_id[items[i]['sceneItemId']] = "Matchpoint";
                            id_item['Matchpoint'] = items[i]['sceneItemId'];
                        }
                        if(items[i]['sourceName'] == 'AvvisoFineSet'){
                            console.log("FineSet:",items[i]['sceneItemId']);
                            item_id[items[i]['sceneItemId']] = "FineSet";                            
                            id_item['FineSet'] = items[i]['sceneItemId'];
                        }
                        if(items[i]['sourceName'] == 'AvvisoTimeOut'){
                            console.log("Timeout:",items[i]['sceneItemId']);
                            item_id[items[i]['sceneItemId']] = "Timeout";
                            id_item['Timeout'] = items[i]['sceneItemId'];
                        }
                    }
                    getVisibility();
                    //setInterval(getVisibility(),7);
                }else if(JSON.parse(event.data)['d']['requestType'] == "GetSceneItemEnabled"){
                    data = JSON.parse(event.data)['d'];
                    if((data['responseData']['sceneItemEnabled'])){
                        $("#M"+item_id[data['requestId']]).hide();
                        $("#N"+item_id[data['requestId']]).show();
                    }else{
                        $("#N"+item_id[data['requestId']]).hide();
                        $("#M"+item_id[data['requestId']]).show();
                    }
                }
            }
        };

        socket.onclose = function(event) {
            if (event.wasClean) {
                console.log(`[OBS] Connection closed cleanly, code=${event.code} reason=${event.reason}`);
            } else {
                // e.g. server process killed or network down
                // event.code is usually 1006 in this case
                console.log('[OBS] Connection died');
                alert("La connessione a OBS è terminata");
            }
        };

        socket.onerror = function(error) {
            console.log(`[OBS error]`);
            alert("Errore server OBS... ");
        }; 

        py_sock.onopen = function(e) {
            console.log("[Python] Py Connection established"); 
        };

        py_sock.onmessage = function(event) {
            console.log(`[Python] Data received from  Py server:`);
            console.log(JSON.parse(event.data));
            if(JSON.parse(event.data)["code"] == "[C]"){
                var py_salt = JSON.parse(event.data)["val"];
                hash(psw + py_salt).then(function(value){
                    let py_auth = hexToBase64(value);                 
                    let auth = {"code":"[C]","val":py_auth};
                    py_sock.send(JSON.stringify(auth));
                    //console.log(py_auth);
                });
            }else if(JSON.parse(event.data)["code"] == "[A]"){
                if(JSON.parse(event.data)["val"] == "OK"){
                    console.log("-#-#-[ SERVER PYTHON PRONTO AL FUNZIONAMENTO ]-#-#-");
                    setInterval(file_read(),5);
                }else{
                    console.log("-!-!-[ IL SERVER PYTHON HA RIFIUTATO LA CONNESSIONE]-!-!-");
                }
            }else if(JSON.parse(event.data)["code"] == "[Read]"){
                $("#Punti1").html(JSON.parse(event.data)["val"][0]);
                $("#Punti2").html(JSON.parse(event.data)["val"][1]);
                $("#Set1").html(JSON.parse(event.data)["val"][2]);
                $("#Set2").html(JSON.parse(event.data)["val"][3]);
                RunAutoPilot();
            }
        };

        py_sock.onclose = function(event) {
            if (event.wasClean) {
                console.log(`[Python] Py Connection closed cleanly, code=${event.code} reason=${event.reason}`);
            } else {
                // e.g. server process killed or network down
                // event.code is usually 1006 in this case
                console.log('[Python] Py Connection died');
                alert("La connessione a Python è terminata");
            }
        };

        py_sock.onerror = function(error) {
            console.log(`[Python error]`);
            alert("Errore server Python... ");
        }; 

        function RunAutoPilot(reset = false){
            if(! AP_Enable) return;

            if((lastWinner > 0) && reset && (AP_AntiSpam != "RST")){
                update("Set"+lastWinner , 1);
                console.log("%c[AutoPilot]: Aumentato numero Set squadra "+lastWinner, AP_LogStyle);
                lastWinner = 0;
                AP_AntiSpam = "RST";
            }
            let P1 = parseInt($("#Punti1").html(), 10);
            let P2 = parseInt($("#Punti2").html(), 10);
            let P_max = Math.max(P1, P2);
            let P_min = Math.min(P1, P2);
            console.log("#### Pre: "+AP_AntiSpam);
            if(P_max >= Goal - 1){
                if((P_max == P_min) && (P_max >= Goal + G_shift - 2)){
                    toggle("Matchpoint",false);
                    G_shift++;
                    console.log("%c[AutoPilot]: Nascondo Matchpoint (Nuovo Goal a "+(Goal + G_shift)+")",AP_LogStyle);
                }else if((P_max == (Goal + G_shift) - 1) && (P_max > P_min) && (AP_AntiSpam != "MMP")){
                    toggle("Matchpoint",true);
                    console.log("%c[AutoPilot]: Mostro Matchpoint",AP_LogStyle);
                    AP_AntiSpam = "MMP";
                }else if((P_max == (Goal + G_shift)) && (AP_AntiSpam != "WIN")){
                    toggle("FineSet", true);
                    lastWinner = (P1 > P2)? 1 : 2;
                    console.log("%c[AutoPilot]: Mostro FineSet (Vince squadra: "+lastWinner+")",AP_LogStyle);
                    (AP_AntiSpam != "WIN");
                }else if((P_max < Goal + G_shift - 1)){
                    G_shift--;
                    console.log("%c[AutoPilot]: Rilevato abbassamento goal (Nuovo Goal a "+(Goal + G_shift)+")",AP_LogStyle);
                }
            }else if(AP_AntiSpam != "NORM"){
                toggle("FineSet", false);
                toggle("Matchpoint", false);
                G_shift = 0;
                console.log("%c[AutoPilot]: Nascondo Matchpoint",AP_LogStyle);
                console.log("%c[AutoPilot]: Nascondo FineSet (Nuovo Goal a "+(Goal + G_shift)+")",AP_LogStyle);
                AP_AntiSpam = "NORM";
            }
            
            if((parseInt($("#Set1").html(), 10) + parseInt($("#Set2").html(), 10) >= 4) && (AP_AntiSpam_Goal != "STB")){
                Goal = HalfGoal;
                console.log("%c[AutoPilot]: Tie Break (Nuovo Goal a "+(Goal + G_shift)+")",AP_LogStyle);
                AP_AntiSpam_Goal = "STB";
            }else if(AP_AntiSpam_Goal != "SNB"){
                Goal = FullGoal;
                AP_AntiSpam_Goal = "SNB";
            }

            $("#goal").val("Goal: "+(Goal+G_shift));
            console.log("#### Post: "+AP_AntiSpam);
        }

        function file_read(){
            let command = {"code":"[Read]"};
            py_sock.send(JSON.stringify(command));
        }

        function update(campo, progressivo){
            let command = {"code":"[Write]", "val":{"campo":campo,"progressivo":progressivo}};
            py_sock.send(JSON.stringify(command));
        }

        function reset(){
            if(confirm("Sei sicuro di voler resettare i punti?")){
                let command = {"code":"[Reset]"};
                py_sock.send(JSON.stringify(command));
                RunAutoPilot(true);
            }
        }
        
        function toggle(name, value, scena = "Punteggio"){
            if(value && now_showed){
                toggle(now_showed, false);
                sleep(250);
            }
            let command = {
                "op": 6,
                "d": {
                    "requestType": "SetSceneItemEnabled",
                    "requestId": "",
                    "requestData": {
                        "sceneName": scena,
                        "sceneItemId": id_item[name],
                        "sceneItemEnabled": value,
                    }
                }
            }
            socket.send(JSON.stringify(command));
            var prefix_to_hide = (value) ? "M" : "N";
            var prefix_to_show = (value) ? "N" : "M";
            $("#"+prefix_to_hide+name).hide();
            $("#"+prefix_to_show+name).show();
            if(value){
                now_showed = name;
            }
            setTimeout(getVisibility, 3000);

        }

        function getVisibility(scena = "Punteggio"){
            console.log("#### Get Visibility");
            for(item in item_id){
                let command = {
                    "op": 6,
                    "d": {
                        "requestType": "GetSceneItemEnabled",
                        "requestId": item,
                        "requestData": {
                            "sceneName": scena,
                            "sceneItemId": parseInt(item)
                        }
                    }
                }
                socket.send(JSON.stringify(command));
            }
        }

        function getItem(){
            let command = {
                "op": 6,
                "d": {
                    "requestType": "GetSceneItemList",
                    "requestId": "",
                    "requestData": {
                        "sceneName": "Punteggio"
                    }
                }
            }
            socket.send(JSON.stringify(command));
        }

        async function hash(string) {
            const utf8 = new TextEncoder().encode(string);
            const hashBuffer = await crypto.subtle.digest('SHA-256', utf8);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray
            .map((bytes) => bytes.toString(16).padStart(2, '0'))
            .join('');
            return hashHex;
        }

        function hexToBase64(hexstring) {
            return btoa(hexstring.match(/\w{2}/g).map(function(a) {
                return String.fromCharCode(parseInt(a, 16));
            }).join(""));
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

    }catch(e){
        alert("Qualcosa è andato storto... " + e);
    }
//}

$("p").addClass("user-select-none"); //Cursore

$('#AP_Sw').change(function() {
    if(this.checked) {
        console.log("%c[Autopilot]: Abilitato",AP_LogStyle);
        AP_Enable = true;
        RunAutoPilot();
    }else{
        if(confirm("Sei sicuro di voler disattivare AutoPilot?")){
            console.log("%c[Autopilot]: Disabilitato",AP_LogStyle);
            AP_Enable = false
            $("#goal").val("--");
        }else{
            $('#AP_Sw').prop("checked",true);
        }
    }
});

function forceClose(){
    socket.close();
}